{"version":3,"sources":["../../../../../src/app/launcher/service/mission-runtime.service.ts"],"names":[],"mappings":"AACA,OAAO,KAAK,CAAC,MAAM,QAAQ,CAAC;AAK5B,MAAM,CAAN,IAAY,WAGX;AAHD,WAAY,WAAW;IACrB,mEAAe,CAAA;IACf,mFAAuB,CAAA;AACzB,CAAC,EAHW,WAAW,KAAX,WAAW,QAGtB;AAED;IAAA;IAIA,CAAC;IAAD,wBAAC;AAAD,CAJA,AAIC,IAAA;;AAED;;GAEG;AACH;IAAA;IAiGA,CAAC;IA/FQ,0CAAoB,GAA3B,UAA4B,QAAmB,EACnB,OAAgB,EAChB,SAAkB,EAClB,SAAkB,EAClB,SAAkB;QAC5C,IAAM,iBAAiB,GAAG,QAAQ,CAAC,MAAM,CAAC,UAAA,CAAC;YACzC,MAAM,CAAC,CAAC,CAAC,SAAS,IAAI,CAAC,CAAC,OAAO,CAAC,EAAE,KAAK,SAAS,CAAC;mBAC5C,CAAC,CAAC,SAAS,IAAI,CAAC,CAAC,OAAO,CAAC,EAAE,KAAK,SAAS,CAAC;mBAC1C,CAAC,CAAC,SAAS,IAAI,CAAC,CAAC,OAAO,CAAC,EAAE,KAAK,SAAS,CAAC,CAAC;QAClD,CAAC,CAAC,CAAC;QACH,EAAE,CAAC,CAAC,iBAAiB,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,CAAC;YACnC,MAAM,CAAC,EAAE,KAAK,EAAE,IAAI,EAAE,WAAW,EAAE,WAAW,CAAC,eAAe,EAAE,QAAQ,EAAE,EAAE,EAAE,CAAC;QACjF,CAAC;QACD,EAAE,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC;YACb,MAAM,CAAC,EAAE,KAAK,EAAE,KAAK,EAAE,QAAQ,EAAE,iBAAiB,EAAE,CAAC;QACvD,CAAC;QACD,IAAM,wBAAwB,GAAG,iBAAiB,CAAC,MAAM,CAAC,UAAA,CAAC;YACzD,MAAM,CAAC,qBAAqB,CAAC,kBAAkB,CAAC,CAAC,EAAE,OAAO,CAAC,CAAC;QAC9D,CAAC,CAAC,CAAC;QACH,EAAE,CAAC,CAAC,wBAAwB,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,CAAC;YAC1C,MAAM,CAAC,EAAE,KAAK,EAAE,IAAI,EAAE,WAAW,EAAE,WAAW,CAAC,uBAAuB,EAAE,QAAQ,EAAE,EAAE,EAAE,CAAC;QACzF,CAAC;QACD,MAAM,CAAC,EAAE,KAAK,EAAE,KAAK,EAAE,QAAQ,EAAE,wBAAwB,EAAE,CAAC;IAC9D,CAAC;IAEM,qCAAe,GAAtB,UAAuB,CAAiB,EAAE,CAAiB;QACzD,IAAM,UAAU,GAAY,CAAC,CAAC,GAAG,CAAC,CAAC,EAAE,oBAAoB,EAAE,KAAK,CAAC,CAAC;QAClE,IAAM,UAAU,GAAY,CAAC,CAAC,GAAG,CAAC,CAAC,EAAE,oBAAoB,EAAE,KAAK,CAAC,CAAC;QAClE,EAAE,CAAC,CAAC,UAAU,KAAK,UAAU,CAAC,CAAC,CAAC;YAC9B,MAAM,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAC7B,CAAC;QACD,0EAA0E;QAC1E,IAAM,UAAU,GAAG,CAAC,CAAC,EAAE,CAAC,OAAO,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QAClD,IAAM,UAAU,GAAG,CAAC,CAAC,EAAE,CAAC,OAAO,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QAClD,EAAE,CAAC,CAAC,UAAU,KAAK,UAAU,CAAC,CAAC,CAAC;YAC9B,MAAM,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAC7B,CAAC;QACD,MAAM,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,aAAa,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;IACvC,CAAC;IAEc,wCAAkB,GAAjC,UAAkC,OAAgB,EAAE,OAAe;QACjE,IAAI,aAAa,GAAG,IAAI,CAAC;QACzB,IAAI,MAAM,GAAG,CAAC,CAAC,GAAG,CAAC,OAAO,EAAE,8BAA8B,CAAC,CAAC;QAC5D,EAAE,CAAC,CAAC,OAAO,MAAM,KAAK,QAAQ,CAAC,CAAC,CAAC;YAC/B,MAAM,GAAG,CAAC,MAAM,CAAC,CAAC;QACpB,CAAC;QACD,EAAE,CAAC,CAAC,MAAM,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC,CAAC;YAClC,GAAG,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;gBACvC,IAAI,iBAAiB,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;gBAClC,EAAE,CAAC,CAAC,CAAC,iBAAiB,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;oBACvC,aAAa,GAAG,KAAK,CAAC;gBACxB,CAAC;gBACD,EAAE,CAAC,CAAC,iBAAiB,CAAC,WAAW,EAAE,KAAK,KAAK;uBACxC,iBAAiB,CAAC,WAAW,EAAE,KAAK,GAAG;uBACvC,iBAAiB,CAAC,iBAAiB,EAAE,KAAK,OAAO,CAAC,CAAC,CAAC;oBACvD,MAAM,CAAC,IAAI,CAAC;gBACd,CAAC;gBAAC,IAAI,CAAC,EAAE,CAAC,CAAC,iBAAiB,CAAC,WAAW,EAAE,KAAK,MAAM;uBAChD,iBAAiB,CAAC,WAAW,EAAE,KAAK,IAAI;uBACxC,iBAAiB,CAAC,WAAW,EAAE,KAAK,CAAC,GAAG,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC;oBACzD,MAAM,CAAC,KAAK,CAAC;gBACf,CAAC;YACH,CAAC;QACH,CAAC;QACD,MAAM,CAAC,aAAa,CAAC;IACvB,CAAC;IAEc,oCAAc,GAA7B,UAA8B,OAAgB;QAC5C,IAAM,WAAW,GAAG,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;QACpD,IAAM,WAAW,GAAG,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;QACpD,MAAM,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,CAAC,UAAA,CAAC;YAC3B,IAAM,OAAO,GAAmB,WAAW,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;YACvD,IAAM,OAAO,GAAmB,WAAW,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC;YACvD,EAAE,CAAC,CAAC,CAAC,OAAO,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC;gBACzB,MAAM,IAAI,KAAK,CAAC,8BAA4B,IAAI,CAAC,SAAS,CAAC,CAAC,CAAG,CAAG,CAAC;YACrE,CAAC;YACD,MAAM,CAAC;gBACL,IAAI,EAAE,CAAC,CAAC,IAAI;gBACZ,WAAW,EAAE,CAAC,CAAC,WAAW;gBAC1B,QAAQ,EAAE,CAAC,CAAC,QAAQ;gBACpB,OAAO,EAAE,OAAO;gBAChB,OAAO,EAAE,OAAO;gBAChB,MAAM,EAAE,CAAC,CAAC,MAAM;gBAChB,OAAO,EAAE,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAA,CAAC,IAAI,OAAA,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,OAAO,EAAlB,CAAkB,CAAC;aACxD,CAAC;QACJ,CAAC,CAAC,CAAA;IACJ,CAAC;IAED,2CAAW,GAAX;QACE,MAAM,CAAC,IAAI,CAAC,UAAU,EAAE;aACrB,GAAG,CAAC,UAAA,CAAC,IAAI,OAAA,qBAAqB,CAAC,cAAc,CAAC,CAAC,CAAC,EAAvC,CAAuC,CAAC,CACjD;IACL,CAAC;IAIH,4BAAC;AAAD,CAjGA,AAiGC,IAAA","file":"mission-runtime.service.js","sourceRoot":"","sourcesContent":["import { Observable } from 'rxjs/Observable';\nimport * as _ from 'lodash';\nimport { Catalog, CatalogMission, CatalogRuntime } from '../model/catalog.model';\nimport { Booster, BoosterRuntime, BoosterVersion } from '../model/booster.model';\n\n\nexport enum EmptyReason {\n  NOT_IMPLEMENTED,\n  CLUSTER_INCOMPATIBILITY\n}\n\nexport class AvailableBoosters {\n  empty: boolean;\n  emptyReason?: EmptyReason;\n  boosters: Booster[];\n}\n\n/**\n * Abstract mission runtime service provided to ensure consumer implements this pattern\n */\nexport abstract class MissionRuntimeService {\n\n  static getAvailableBoosters(boosters: Booster[],\n                              cluster?: string,\n                              missionId?: string,\n                              runtimeId?: string,\n                              versionId?: string): AvailableBoosters {\n    const availableBoosters = boosters.filter(b => {\n      return (!missionId || b.mission.id === missionId)\n        && (!runtimeId || b.runtime.id === runtimeId)\n        && (!versionId || b.version.id === versionId);\n    });\n    if (availableBoosters.length === 0) {\n      return { empty: true, emptyReason: EmptyReason.NOT_IMPLEMENTED, boosters: [] };\n    }\n    if (!cluster) {\n      return { empty: false, boosters: availableBoosters };\n    }\n    const boostersRunningOnCluster = availableBoosters.filter(b => {\n      return MissionRuntimeService.checkRunsOnCluster(b, cluster);\n    });\n    if (boostersRunningOnCluster.length === 0) {\n      return { empty: true, emptyReason: EmptyReason.CLUSTER_INCOMPATIBILITY, boosters: [] };\n    }\n    return { empty: false, boosters: boostersRunningOnCluster };\n  }\n\n  static compareVersions(a: BoosterVersion, b: BoosterVersion): number {\n    const aSuggested: boolean = _.get(a, 'metadata.suggested', false);\n    const bSuggested: boolean = _.get(b, 'metadata.suggested', false);\n    if (aSuggested !== bSuggested) {\n      return aSuggested ? -1 : 1;\n    }\n    // TODO remove this 'community' hook mainteners should use suggested field\n    const aCommunity = a.id.indexOf('community') >= 0;\n    const bCommunity = b.id.indexOf('community') >= 0;\n    if (aCommunity !== bCommunity) {\n      return aCommunity ? -1 : 1;\n    }\n    return -1 * a.id.localeCompare(b.id);\n  }\n\n  private static checkRunsOnCluster(booster: Booster, cluster: string) {\n    let defaultResult = true;\n    let runsOn = _.get(booster, 'metadata.app.launcher.runsOn');\n    if (typeof runsOn === 'string') {\n      runsOn = [runsOn];\n    }\n    if (runsOn && runsOn.length !== 0) {\n      for (let i = 0; i < runsOn.length; i++) {\n        let supportedCategory = runsOn[i];\n        if (!supportedCategory.startsWith('!')) {\n          defaultResult = false;\n        }\n        if (supportedCategory.toLowerCase() === 'all'\n          || supportedCategory.toLowerCase() === '*'\n          || supportedCategory.toLocaleLowerCase() === cluster) {\n          return true;\n        } else if (supportedCategory.toLowerCase() === 'none'\n          || supportedCategory.toLowerCase() === '!*'\n          || supportedCategory.toLowerCase() === ('!' + cluster)) {\n          return false;\n        }\n      }\n    }\n    return defaultResult;\n  }\n\n  private static createBoosters(catalog: Catalog): Booster[] {\n    const missionById = _.keyBy(catalog.missions, 'id');\n    const runtimeById = _.keyBy(catalog.runtimes, 'id');\n    return catalog.boosters.map(b => {\n      const runtime: CatalogRuntime = runtimeById[b.runtime];\n      const mission: CatalogMission = missionById[b.mission];\n      if (!mission || !runtime) {\n        throw new Error(`Invalid catalog booster: ${JSON.stringify(b)}`  );\n      }\n      return {\n        name: b.name,\n        description: b.description,\n        metadata: b.metadata,\n        mission: mission,\n        runtime: runtime,\n        source: b.source,\n        version: runtime.versions.find(v => v.id === b.version)\n      };\n    })\n  }\n\n  getBoosters(): Observable<Booster[]> {\n    return this.getCatalog()\n      .map(c => MissionRuntimeService.createBoosters(c))\n      ;\n  }\n\n  abstract getCatalog(): Observable<Catalog>;\n\n}\n"]}